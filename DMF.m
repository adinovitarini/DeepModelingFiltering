function [delta_x,StateLSTM,KG,time_elapsed,EKFNet]=DMF(TEST,net,N,nh)
nh = net.Layers(2).NumHiddenUnits;
Wi = net.Layers(2).InputWeights(1:nh,1);
Wf = net.Layers(2).InputWeights(nh+1:2*nh,1);
Wc = net.Layers(2).InputWeights(2*nh+1:3*nh,1);
Wo = net.Layers(2).InputWeights(3*nh+1:4*nh,1);
Ri = net.Layers(2).RecurrentWeights(1:nh,:);
Rf = net.Layers(2).RecurrentWeights(nh+1:2*nh,:);
Rc = net.Layers(2).RecurrentWeights(2*nh+1:3*nh,:);
Ro = net.Layers(2).RecurrentWeights(3*nh+1:4*nh,:);
% N = 100;
hh = zeros(nh,N); %state 
% y_hat = zeros(1,N); %out 
y = TEST.input;
% y = dataset_cp_test.y;
inputGate = zeros(nh,1);
forgetGate = inputGate;
outGate = inputGate;
cellGate = inputGate;
cellState = net.Layers(2).CellState(:,1);
hh = cellState(:,1);
for i = 1:N
    inputGate(:,i) = 1./(1+exp((Wi*y(i)+Ri*hh(:,i))));
    forgetGate(:,i) = 1./(1+exp((Wf*y(i)+Rf*hh(:,i))));
    cellGate(:,i) = tanh(Wc*y(i)+Rc*hh(:,i));
    outGate(:,i) = 1./(1+exp((Wo*y(i)+Ro*hh(:,i))));
    cellGate(:,i+1) = inputGate(:,i).*forgetGate(:,i).*cellGate(:,i).*outGate(:,i);
    hh(:,i+1) = outGate(:,i).*tanh(cellGate(:,i));
end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
%% State Transition Map
hh = hh(:,1:N);
cellGate = cellGate(:,1:N);
hiddenState = net.Layers(2).HiddenState(:,1);
% x_hat = 0.1*ones(nb,N);
x_hat(:,1) = hiddenState(:,1);
% Y = dataset_dt.y_nw(:,1:N);
% Y = TEST.input';
Y = ZERO.input';
x_posterior = 0.1*ones(nh,N);
delta_x = x_posterior;
[F_hat,H_hat] = derivativeEKF(net,N,TEST);
for i = 1:N
%     x_hat(:,i+1) = forgetGate(:,i).*x_hat(:,i) + inputGate(:,i).*cellGate(:,i);
    x_hat(:,i+1) = F_hat*x_hat(:,i);
    delta_x(:,i) = x_hat(:,i)-x_posterior(:,i);
%     y_hat(:,i) = hiddenState'*outGate(:,i);
    y_hat(:,i) = H_hat'*x_hat(:,i+1);
    x_hat(:,i) = x_hat(:,i+1); 
    delta_y(:,i) = Y(:,i)-y_hat(:,i);
    [KG(:,i),time_elapsed,EKFNet] = ExtendedKalmanNet(delta_x(:,i),delta_y(:,i));
    x_posterior(:,i+1) = (KG(:,i).*delta_y(:,i))+x_hat(:,i+1);
end
StateLSTM.x_hat = x_hat;
StateLSTM.y_hat = y_hat;
